# Quadrant Analysis

Quadrant analysis is a simple conditional sampling method to detect coherent structures directly from the high-frequency measurements. For this, the Reddy package provides two functions: `calc_quadrant_analysis` for calculating occurrence frequency and strength of the four quadrants and `plot_quadrant_analysis` for plotting the two variables as scatter plot with a 2d kernel density estimation and a linear regression.


```R
#loading Reddy package
install.packages("../src/Reddy_0.0.0.9000.tar.gz",repos=NULL,source=TRUE)
library(Reddy)

#ec data files
dir_in="../data/ec-data_10Hz_raw"
files=list.files(dir_in,full.names=TRUE)
nf=length(files)
```

    Installing package into ‘/home/lauracma/R/x86_64-pc-linux-gnu-library/4.0’
    (as ‘lib’ is unspecified)
    


## Calculation of occurrence frequencies and strengths of the four quadrants with `calc_quadrant_analysis`
The two variables are normalized (if `do_normalization = TRUE`) through
$$ \hat{x} = \frac{x-\overline{x}}{\sigma_x}$$
by substracting the mean value $\overline{x}$ and dividing by $\sigma_x$ to make different variables with different value ranges comparable and centered around zero. The function counts the occurrence frequency of each quadrant, calculates their strength as product $\hat{x}\hat{y}$ and as covariance $\overline{\hat{x}'\hat{y}'}$. The parameter `hole_sizes`can be used to filter out very strong events by applying the filter conditions $\vert \hat{x}\hat{y} \vert \le H \cdot \vert \overline{\hat{x}'\hat{y}'}\vert$. Usually, $y$ is chosen to be the vertical velocity $w$.


```R
i=8 #select a file
tmp=read.table(files[i],sep=",",header=T)

qa_Tw=calc_quadrant_analysis(tmp$T_degC,tmp$w_m.s) #based on the raw data (10 Hz) directly (i.e., unrotated)
qa_Tw
```


<dl>
	<dt>$hole_sizes</dt>
		<dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li></ol>
</dd>
	<dt>$occurrence</dt>
		<dd><table class="dataframe">
<caption>A matrix: 4 × 11 of type int</caption>
<tbody>
	<tr><td>5448</td><td>4689</td><td>4232</td><td>3829</td><td>3542</td><td>3355</td><td>3214</td><td>3120</td><td>3071</td><td>3043</td><td>3017</td></tr>
	<tr><td>2975</td><td> 144</td><td>   8</td><td>   1</td><td>   0</td><td>   0</td><td>   0</td><td>   0</td><td>   0</td><td>   0</td><td>   0</td></tr>
	<tr><td>6619</td><td>3812</td><td>3732</td><td>4177</td><td>4539</td><td>4821</td><td>5015</td><td>5153</td><td>5238</td><td>5302</td><td>5345</td></tr>
	<tr><td>2958</td><td> 300</td><td>  71</td><td>  19</td><td>   4</td><td>   1</td><td>   0</td><td>   0</td><td>   0</td><td>   0</td><td>   0</td></tr>
</tbody>
</table>
</dd>
	<dt>$product</dt>
		<dd><table class="dataframe">
<caption>A matrix: 4 × 11 of type dbl</caption>
<tbody>
	<tr><td> 1.0680473</td><td> 0.8157981</td><td> 0.5926998</td><td> 0.4160602</td><td> 0.2595930</td><td> 0.128415</td><td>0.00496475</td><td>-0.09889583</td><td>-0.1580028</td><td>-0.1941919</td><td>-0.2292195</td></tr>
	<tr><td>-0.2913532</td><td>-1.3388982</td><td>-2.3107778</td><td>-3.0595706</td><td>       NaN</td><td>      NaN</td><td>       NaN</td><td>        NaN</td><td>       NaN</td><td>       NaN</td><td>       NaN</td></tr>
	<tr><td> 0.6190221</td><td> 0.3023105</td><td> 0.3188273</td><td> 0.4780481</td><td> 0.6247966</td><td> 0.729391</td><td>0.81096819</td><td> 0.88180372</td><td> 0.9271087</td><td> 0.9649898</td><td> 0.9919303</td></tr>
	<tr><td>-0.4200449</td><td>-1.6791768</td><td>-2.7216259</td><td>-3.5668925</td><td>-4.3541217</td><td>-5.200543</td><td>       NaN</td><td>        NaN</td><td>       NaN</td><td>       NaN</td><td>       NaN</td></tr>
</tbody>
</table>
</dd>
	<dt>$covariance</dt>
		<dd><table class="dataframe">
<caption>A matrix: 4 × 11 of type dbl</caption>
<tbody>
	<tr><td> 0.106717873</td><td>0.3190217</td><td>0.3943558</td><td>0.39175959</td><td>0.33878042</td><td>0.28464356</td><td>0.22478907</td><td>0.16509696</td><td>0.13053088</td><td>0.10926006</td><td>0.08895242</td></tr>
	<tr><td> 0.053090898</td><td>0.1180140</td><td>0.1147860</td><td>        NA</td><td>        NA</td><td>        NA</td><td>        NA</td><td>        NA</td><td>        NA</td><td>        NA</td><td>        NA</td></tr>
	<tr><td>-0.009141232</td><td>0.2882998</td><td>0.1194031</td><td>0.04190299</td><td>0.05120756</td><td>0.06056233</td><td>0.06900792</td><td>0.07814975</td><td>0.08542762</td><td>0.09238304</td><td>0.09700542</td></tr>
	<tr><td> 0.032263914</td><td>0.1706475</td><td>0.2092321</td><td>0.09659086</td><td>0.05461222</td><td>        NA</td><td>        NA</td><td>        NA</td><td>        NA</td><td>        NA</td><td>        NA</td></tr>
</tbody>
</table>
</dd>
	<dt>$covariance_total</dt>
		<dd>0.149572439233721</dd>
	<dt>$correlation_total</dt>
		<dd>0.433733025048198</dd>
	<dt>$meta</dt>
		<dd>'Output format: rows represent the quadrants Q1, Q2, Q3, Q4 -- columns: selected hole sizes'</dd>
</dl>



## Plotting quadrant analysis with `plot_quadrant_analysis`
`plot_quadrant_analysis` plots a scatter plot of two variables with a 2d kernel density estimation (`MASS::kde2d`) and a linear regression (`lm()`) to allow for a visual inspection.

**Example: Quadrant Analysis (T,w) during daytime**


```R
i=8 #select a file -- a daytime example
print(files[i])
tmp=read.table(files[i],sep=",",header=T)

plot_quadrant_analysis(tmp$T_degC,tmp$w_m.s,xlab="T (normalized)",ylab="w (normalized)",main="Quadrant Analysis (T,w)")
```

    [1] "../data/ec-data_10Hz_raw/2018-07-20T120000.csv"
    
    Call:
    lm(formula = yval ~ xval)
    
    Residuals:
        Min      1Q  Median      3Q     Max 
    -4.5818 -0.5491  0.0005  0.5471  4.1136 
    
    Coefficients:
                  Estimate Std. Error t value Pr(>|t|)    
    (Intercept) -3.849e-16  6.716e-03    0.00        1    
    xval         4.337e-01  6.716e-03   64.58   <2e-16 ***
    ---
    Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
    
    Residual standard error: 0.9011 on 17998 degrees of freedom
    Multiple R-squared:  0.1881,	Adjusted R-squared:  0.1881 
    F-statistic:  4170 on 1 and 17998 DF,  p-value: < 2.2e-16
    



    
![png](output_6_1.png)
    


**Example: Quadrant Analysis (T,w) during nighttime**


```R
i=38 #select a file -- a nighttime example
print(files[i])
tmp=read.table(files[i],sep=",",header=T)
plot_quadrant_analysis(tmp$T_degC,tmp$w_m.s) #based on the raw data (10 Hz) directly (i.e., unrotated)
```

    [1] "../data/ec-data_10Hz_raw/2018-07-21T030000.csv"
    
    Call:
    lm(formula = yval ~ xval)
    
    Residuals:
        Min      1Q  Median      3Q     Max 
    -5.8334 -0.5262  0.0022  0.5425  6.2520 
    
    Coefficients:
                  Estimate Std. Error t value Pr(>|t|)    
    (Intercept) -3.006e-17  7.120e-03    0.00        1    
    xval        -2.957e-01  7.121e-03  -41.53   <2e-16 ***
    ---
    Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
    
    Residual standard error: 0.9553 on 17998 degrees of freedom
    Multiple R-squared:  0.08745,	Adjusted R-squared:  0.0874 
    F-statistic:  1725 on 1 and 17998 DF,  p-value: < 2.2e-16
    



    
![png](output_8_1.png)
    


**Example: Quadrant Analysis (u,w) during nighttime**


```R
plot_quadrant_analysis(tmp$u_m.s,tmp$w_m.s) #based on the raw data (10 Hz) directly (i.e., unrotated)
```

    
    Call:
    lm(formula = yval ~ xval)
    
    Residuals:
        Min      1Q  Median      3Q     Max 
    -5.9799 -0.5474 -0.0342  0.5301  6.6338 
    
    Coefficients:
                  Estimate Std. Error t value Pr(>|t|)    
    (Intercept) -3.749e-16  7.326e-03    0.00        1    
    xval        -1.843e-01  7.326e-03  -25.15   <2e-16 ***
    ---
    Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
    
    Residual standard error: 0.9829 on 17998 degrees of freedom
    Multiple R-squared:  0.03395,	Adjusted R-squared:  0.0339 
    F-statistic: 632.5 on 1 and 17998 DF,  p-value: < 2.2e-16
    



    
![png](output_10_1.png)
    


Quadrant analysis can be applied to any combination of two measured quantities and also allows to check the measurement quality or significance of the relation between them. It can also be used to check the effect of the coordinate rotation (e.g., `rotate_double`) visually.

## Literature
- Li, D. and Bou-Zeid, E. (2011). Coherent Structures and the Dissimilarity of
Turbulent Transport of Momentum and Scalars in the Unstable Atmospheric
Surface Layer. Boundary-Layer Meteorol, 140:243–262.
- Wallace, J. (2016). Quadrant Analysis in Turbulence Research: History and
Evolution. Annu Rev Fluid Mech, 48:131–158.
